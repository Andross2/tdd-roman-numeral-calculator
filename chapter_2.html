<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}


#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_chapter_2_testing_exceptions_and_using_loops">Chapter 2 - Testing Exceptions and using loops</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the last chapter we covered the basics of TDD:  writing tests first, driving
incremental code changes using the tests.  I want to continue with the example
to show how TDD can also help us to drive code design.</p></div>
<div class="sect2">
<h3 id="_testing_error_cases_and_raising_exceptions">Testing error cases and raising exceptions:</h3>
<div class="paragraph"><p>Let&#8217;s start by extending our tests.  Our "minimum viable calculator" can
currently add I + I, but calling it viable may be a bit of a stretch!  For
starters, although it&#8217;s only currently designed to add I&#8217;s, it will actually
accept almost any input at all, and will probably return nonsense outputs.</p></div>
<div class="paragraph"><p>Let&#8217;s make it return a sensible error if it gets input it doesn&#8217;t know how to
handle.  As usual, test-first, we start by specifying how we want the code to
behave, from the point of view of the caller:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> unittest
<span style="font-weight: bold"><span style="color: #000080">from</span></span> rome <span style="font-weight: bold"><span style="color: #000080">import</span></span> add

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">AdditionTest</span></span><span style="color: #990000">(</span>unittest<span style="color: #990000">.</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_adding_Is</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'I'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'I'</span><span style="color: #990000">),</span> <span style="color: #FF0000">'II'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'I'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'II'</span><span style="color: #990000">),</span> <span style="color: #FF0000">'III'</span><span style="color: #990000">)</span>


    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_inputs_out_of_scope_raise_exceptions</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        with self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertRaises</span></span><span style="color: #990000">(</span>ValueError<span style="color: #990000">):</span>
            <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'I'</span><span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
        with self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertRaises</span></span><span style="color: #990000">(</span>ValueError<span style="color: #990000">):</span>
            <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'I'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'V'</span><span style="color: #990000">)</span>


<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> __name__ <span style="color: #990000">==</span> <span style="color: #FF0000">'__main__'</span><span style="color: #990000">:</span>
    unittest<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>I&#8217;ve decided to add a new test method, since these tests are quite different
from the tests for addition of I&#8217;s.  Like all variable names, test names should
be nice and descriptive, and in fact, they often are almost human-readable
sentences.  They should summarise what we want our code to do&#8230; I&#8217;ve seen
test method names that extend to almost 100chars&#8201;&#8212;&#8201;after a while though, a
long test method name is a code smell that you might want to break your code
up into smaller pieces.</p></div>
<div class="paragraph"><p>The next thing to introduce is <code>assertRaises</code>.  This is another of unittest&#8217;s
helper functions, and it works as a context manager.  It allows us to run
tests which we now will raise an exceptioin, and to make assertions about
what type of exception we&#8217;ll get.</p></div>
<div class="paragraph"><p>We&#8217;ve started by specifying two possible out-of-scope inputs: a non-Roman
numeral, 2, and a Roman numeral which we don&#8217;t know how to compute yet, <em>V</em>.
Let&#8217;s try running the tests:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>.E
======================================================================
ERROR: test_inputs_out_of_scope_raise_exceptions (__main__.AdditionTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "book0/tests.py", line 13, in test_inputs_out_of_scope_raise_exceptions
    add('I', 2)
  File "/home/harry/Dropbox/book/book0/rome.py", line 2, in add
    return augend + addend
TypeError: cannot concatenate 'str' and 'int' objects

----------------------------------------------------------------------
Ran 2 tests in 0.000s

FAILED (errors=1)</code></pre>
</div></div>
<div class="paragraph"><p>We now have two tests, of which one is failing.  That allows us to go ahead
and write some new code.  The tests are complaining about a TypeError, so let&#8217;s
get rid of it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> addend<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> augend <span style="color: #990000">+</span> addend
    <span style="font-weight: bold"><span style="color: #0000FF">except</span></span> TypeError<span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span></tt></pre></div></div>
<div class="paragraph"><p>Well, that produces a slightly different error:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>.F
======================================================================
FAIL: test_inputs_out_of_scope_raise_exceptions (__main__.AdditionTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "book0/tests.py", line 13, in test_inputs_out_of_scope_raise_exceptions
    add('I', 2)
AssertionError: ValueError not raised

----------------------------------------------------------------------
Ran 2 tests in 0.000s

FAILED (failures=1)</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_how_tests_can_save_us_from_stupidity">How tests can save us from stupidity:</h3>
<div class="paragraph"><p>Obviously our first attempt wasn&#8217;t quite right - we want a ValueError.  Let&#8217;s
go ahead and raise one of those, slightly naively:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> addend<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> augend <span style="color: #990000">+</span> addend</tt></pre></div></div>
<div class="literalblock">
<div class="content">
<pre><code>E.
======================================================================
ERROR: test_adding_Is (__main__.AdditionTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "book0/tests.py", line 7, in test_adding_Is
    self.assertEqual(add('I', 'I'), 'II')
  File "/home/harry/Dropbox/book/book0/rome.py", line 2, in add
    raise ValueError
ValueError

----------------------------------------------------------------------
Ran 2 tests in 0.001s

FAILED (errors=1)</code></pre>
</div></div>
<div class="paragraph"><p>OK, perhaps that&#8217;s not so much naive as downright stupid.  But I&#8217;m using it to
illustrate one of the great things about TDD - it can save you from your own
stupid.  Now, I may well think I&#8217;m not stupid often, I may even fancy myself as
occasionally fairly smart - but I know that, for sure, sometimes I&#8217;m stupid.
It&#8217;s nice to know that the tests are there to cover for me when that happens.</p></div>
<div class="paragraph"><p>Thanks, tests!  (Thests.)</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> addend<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>addend<span style="color: #990000">,</span> basestring<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> augend <span style="color: #990000">+</span> addend</tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s see if that will do the trick:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>.F
======================================================================
FAIL: test_inputs_out_of_scope_raise_exceptions (__main__.AdditionTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "book0/tests.py", line 15, in test_inputs_out_of_scope_raise_exceptions
    add('I', 'V')
AssertionError: ValueError not raised

----------------------------------------------------------------------
Ran 2 tests in 0.001s

FAILED (failures=1)</code></pre>
</div></div>
<div class="paragraph"><p>Another incremental change:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> addend<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>addend<span style="color: #990000">,</span> basestring<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> addend <span style="color: #990000">==</span> <span style="color: #FF0000">'V'</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> augend <span style="color: #990000">+</span> addend</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_looping_through_test_cases">Looping through test cases:</h3>
<div class="paragraph"><p>These naive input validations aren&#8217;t really satisfactory though.  We&#8217;re
only checking on one of the inputs, for starters. Let&#8217;s extend our tests to
cover a wider range of bad inputs, and justify some better input validation.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_inputs_out_of_scope_raise_exceptions</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> bad_input <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">,</span> None<span style="color: #990000">,</span> <span style="color: #FF0000">'Z'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'V'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'X'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'L'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'C'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'D'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'M'</span><span style="color: #990000">):</span>
        with self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertRaises</span></span><span style="color: #990000">(</span>ValueError<span style="color: #990000">)</span> as m<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'I'</span><span style="color: #990000">,</span> bad_input<span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">hasattr</span></span><span style="color: #990000">(</span>m<span style="color: #990000">,</span> <span style="color: #FF0000">'exception'</span><span style="color: #990000">):</span>
                self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'%s as augend did not raise exception'</span> <span style="color: #990000">%</span> bad_input<span style="color: #990000">)</span>

        with self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertRaises</span></span><span style="color: #990000">(</span>ValueError<span style="color: #990000">)</span> as m<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>bad_input<span style="color: #990000">,</span> <span style="color: #FF0000">'I'</span><span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">hasattr</span></span><span style="color: #990000">(</span>m<span style="color: #990000">,</span> <span style="color: #FF0000">'exception'</span><span style="color: #990000">):</span>
                self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'%s as addend did not raise exception'</span> <span style="color: #990000">%</span> bad_input<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>TODO: this is pretty ugly.  but no great way of checking which input raised the
exception otherwise&#8230;</p></div>
<div class="paragraph"><p>There&#8217;s a couple of new things there&#8201;&#8212;&#8201;you&#8217;ll see that <code>assertRaises</code> gives us
a context manager, on which we can make assertions about the exceptions that
was raised.  I&#8217;m also using More importantly, it shows a common testing pattern, which is to
put our tests in our loop in order to check several similar cases.  When we do
this, we need a way of figuring out which of the test values caused the error,
so that&#8217;s why I&#8217;m using <code>self.fail</code>, which is a shortcut to failing out with a
given message.</p></div>
<div class="paragraph"><p>Let&#8217;s see how that does:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>.E
======================================================================
ERROR: test_inputs_out_of_scope_raise_exceptions (__main__.AdditionTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "book0/tests.py", line 19, in test_inputs_out_of_scope_raise_exceptions
    add(bad_input, 'I')
  File "/home/harry/Dropbox/book/book0/rome.py", line 6, in add
    return augend + addend
TypeError: unsupported operand type(s) for +: 'int' and 'str'

----------------------------------------------------------------------
Ran 2 tests in 0.001s

FAILED (errors=1)</code></pre>
</div></div>
<div class="paragraph"><p>That&#8217;s telling us that we need to check both the augend and the addend for
valid inputs. Here&#8217;s a minimal change:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> addend<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> basestring<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>addend<span style="color: #990000">,</span> basestring<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> addend <span style="color: #990000">==</span> <span style="color: #FF0000">'V'</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> augend <span style="color: #990000">+</span> addend</tt></pre></div></div>
<div class="paragraph"><p>We&#8217;re now getting into a familiar TDD cycle:</p></div>
<div class="ulist"><ul>
<li>
<p>
run the tests
</p>
</li>
<li>
<p>
make a minimal code change, driven by the test failure message
</p>
</li>
<li>
<p>
repeat until the tests all pass
</p>
</li>
</ul></div>
<div class="paragraph"><p>Let&#8217;s play it out.  Testing again:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: Z as augend did not raise exception</code></pre>
</div></div>
<div class="paragraph"><p>(I&#8217;m just showing the last line of the test failure output now, to save space)</p></div>
<div class="paragraph"><p>Let&#8217;s fix that:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> addend<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> basestring<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>addend<span style="color: #990000">,</span> basestring<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> addend <span style="color: #990000">==</span> <span style="color: #FF0000">'V'</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> augend <span style="color: #990000">==</span> <span style="color: #FF0000">'Z'</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> augend <span style="color: #990000">+</span> addend</tt></pre></div></div>
<div class="paragraph"><p>Ugly, but let&#8217;s see what the tests want:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: Z as augend did not raise exception</code></pre>
</div></div>
<div class="paragraph"><p>That justifies us to write some slightly cleverer input validation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> addend<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>augend<span style="color: #990000">,</span> basestring<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>addend<span style="color: #990000">,</span> basestring<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    simple_sum <span style="color: #990000">=</span> augend <span style="color: #990000">+</span> addend
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">any</span></span><span style="color: #990000">(</span>char <span style="color: #990000">!=</span> <span style="color: #FF0000">'I'</span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> char <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> simple_sum<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> ValueError
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> simple_sum</tt></pre></div></div>
<div class="paragraph"><p>And that gets the tests to pass!</p></div>
<div class="literalblock">
<div class="content">
<pre><code>..
----------------------------------------------------------------------
Ran 2 tests in 0.000s

OK</code></pre>
</div></div>
<div class="paragraph"><p>Hooray.  In that chapter we covered testing for exceptions, we saw how tests
can save us from our own stupidity, and we learned about looping through test
values.  In the next chapter we&#8217;ll look at refactoring and driving design
through tests.</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-01-26 20:36:42 GMT
</div>
</div>
</body>
</html>
